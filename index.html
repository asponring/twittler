<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="moment.js"></script>
    <script src="data_generator.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
  </head>
  <body>
    <header>
      <h1 class="title">
        Twittler
      </h1>
    </header>
    <section class="tweetStream">
      <h2 class="tweetStreamTitle">
        Your Tweet stream
      </h2>
      <button class="btn">
        Show <span id="numNewTweets"></span> New Tweets
      </button>
      <div class="tweets">
      </div>
    </section>
    <script>
      $(document).ready(function(){
        //2 global-ish variables that help log the state of the tweet stream
        var currentTweetIndex, currentStreamDisplayed;

        var displayNewTweets = function(highestTweetIndex) {
          //make this function safe if no arguments passed in
          if (!highestTweetIndex) { 
            highestTweetIndex = currentStreamDisplayed.length - 1;
          }

          //update the timestamps of current tweets
          updateTimestamps();

          //show the new tweets
          for ( ; currentTweetIndex < highestTweetIndex; currentTweetIndex++) {
            $(".btn").hide();
            var tweet = currentStreamDisplayed[currentTweetIndex];
            var $tweet = $('<div class="tweet"></div>');
            $tweet.html('<span class="username">@' + tweet.user + '</span> &#183; <span class="time">' + moment(tweet.created_at).fromNow() + '</span><br><span class="tweetMsg">' + tweet.message + "</span>");
            $tweet.prependTo($(".tweets"));
            $tweet.on("click", ".username", function() { 
              initTweetStream($(this).text().slice(1));
            });
          }
        };

        var updateTimestamps = function() {
          var tweetTime = $(".time").last();
          for (var i = 0; i < currentTweetIndex; i++) {
            tweetTime.text(moment(currentStreamDisplayed[i].created_at).fromNow());
            tweetTime = tweetTime.parent().prev().find(".time");
          }
        };

        var checkForNewTweets = function() {
          var highestTweetIndex = currentStreamDisplayed.length - 1;
          if (highestTweetIndex > currentTweetIndex) {
            $(".btn").show();
            $("#numNewTweets").text(highestTweetIndex - currentTweetIndex);
            $(".btn").on("click", function() { displayNewTweets(highestTweetIndex); });
          }
        };

        var initTweetStream = function(userName) {
          //if no username passed in, then display all tweets
          if (!userName) {
            currentStreamDisplayed = streams.home;
          } else {
            currentStreamDisplayed = streams.users[userName];
            $(".tweetStreamTitle").text("@" + userName);  
          }
          currentTweetIndex = 0;
          $(".btn").hide();
          $(".tweets").text("");
          displayNewTweets();
        };

        initTweetStream();
        setInterval(checkForNewTweets, 5000);

      });

    </script>
  </body>
</html>